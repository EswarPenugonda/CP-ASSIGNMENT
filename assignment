#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void q1(){
    int *p = malloc(sizeof(int));
    if(p==NULL){ printf("Memory allocation failed\n"); return; }
    printf("Enter an integer: ");
    if(scanf("%d",p)!=1){ printf("Invalid input\n"); free(p); return; }
    printf("You entered: %d\n", *p);
    free(p);
}

void q2(){
    int n;
    printf("Enter number of integers: ");
    if(scanf("%d",&n)!=1 || n<=0){ printf("Invalid number\n"); return; }
    int *arr = calloc(n, sizeof(int));
    if(arr==NULL){ printf("Memory allocation failed\n"); return; }
    for(int i=0;i<n;i++){
        printf("Enter integer %d: ", i+1);
        if(scanf("%d",&arr[i])!=1){ printf("Invalid input\n"); free(arr); return; }
    }
    printf("Stored integers are:\n");
    for(int i=0;i<n;i++) printf("%d ", arr[i]);
    printf("\n");
    free(arr);
}

void q3(){
    int n;
    printf("Enter how many numbers: ");
    if(scanf("%d",&n)!=1 || n<=0){ printf("Invalid number\n"); return; }
    float *arr = malloc(n * sizeof(float));
    if(arr==NULL){ printf("Memory allocation failed\n"); return; }
    float sum=0.0f;
    for(int i=0;i<n;i++){
        printf("Enter number %d: ", i+1);
        if(scanf("%f",&arr[i])!=1){ printf("Invalid input\n"); free(arr); return; }
        sum += arr[i];
    }
    printf("Sum = %.2f\n", sum);
    printf("Average = %.2f\n", sum / n);
    free(arr);
}

void q4(){
    int n;
    printf("Enter size of stack: ");
    if(scanf("%d",&n)!=1 || n<=0){ printf("Invalid size\n"); return; }
    int *stack = malloc(n * sizeof(int));
    if(stack==NULL){ printf("Memory allocation failed\n"); return; }
    int top = -1;
    while(1){
        int choice;
        printf("1.Push 2.Pop 3.Display 4.Exit\nEnter choice: ");
        if(scanf("%d",&choice)!=1){ printf("Invalid input\n"); break; }
        if(choice==1){
            if(top==n-1) printf("Stack Overflow\n");
            else{
                int val;
                printf("Enter value to push: ");
                if(scanf("%d",&val)!=1){ printf("Invalid input\n"); continue; }
                stack[++top]=val;
            }
        } else if(choice==2){
            if(top==-1) printf("Stack Underflow\n");
            else printf("Popped element: %d\n", stack[top--]);
        } else if(choice==3){
            if(top==-1) printf("Stack is Empty\n");
            else{
                printf("Stack elements (top to bottom):\n");
                for(int i=top;i>=0;i--) printf("%d ", stack[i]);
                printf("\n");
            }
        } else if(choice==4) break;
        else printf("Invalid choice\n");
    }
    free(stack);
}

void q5(){
    char fname[260];
    printf("Enter filename to read: ");
    if(scanf("%259s", fname)!=1){ printf("Invalid input\n"); return; }
    FILE *fp = fopen(fname, "r");
    if(fp==NULL){ printf("File cannot be opened\n"); return; }
    int ch;
    while((ch=fgetc(fp))!=EOF) putchar(ch);
    fclose(fp);
    printf("\n");
}

void q6(){
    char fname[260];
    char buffer[1024];
    printf("Enter filename to append to: ");
    if(scanf("%259s", fname)!=1){ printf("Invalid input\n"); return; }
    FILE *fp = fopen(fname, "a");
    if(fp==NULL){ printf("Unable to open file\n"); return; }
    printf("Enter text to append (single line): ");
    int c=getchar();
    if(fgets(buffer, sizeof(buffer), stdin)==NULL){ printf("No input\n"); fclose(fp); return; }
    if(buffer[strlen(buffer)-1]=='\n') buffer[strlen(buffer)-1]='\0';
    fprintf(fp, "%s\n", buffer);
    fclose(fp);
    printf("Text appended successfully\n");
}

void q7(){
    char fname[260];
    printf("Enter student data filename: ");
    if(scanf("%259s", fname)!=1){ printf("Invalid input\n"); return; }
    FILE *fp = fopen(fname, "r");
    if(fp==NULL){ printf("File cannot be opened\n"); return; }
    struct Student{ char name[100]; int roll; float marks; };
    struct Student *arr = NULL;
    int count=0, cap=0;
    while(1){
        char namebuf[100];
        int roll;
        float marks;
        int r = fscanf(fp, "%99s %d %f", namebuf, &roll, &marks);
        if(r==3){
            if(count==cap){
                cap = cap ? cap*2 : 8;
                struct Student *t = realloc(arr, cap * sizeof(struct Student));
                if(t==NULL){ printf("Memory allocation failed\n"); free(arr); fclose(fp); return; }
                arr = t;
            }
            strcpy(arr[count].name, namebuf);
            arr[count].roll = roll;
            arr[count].marks = marks;
            count++;
        } else break;
    }
    fclose(fp);
    if(count==0){ printf("No student records found\n"); free(arr); return; }
    for(int i=0;i<count-1;i++){
        for(int j=i+1;j<count;j++){
            if(arr[i].marks < arr[j].marks){
                struct Student tmp = arr[i];
                arr[i]=arr[j];
                arr[j]=tmp;
            }
        }
    }
    printf("Rank-wise Student List:\n");
    for(int i=0;i<count;i++){
        printf("Rank %d Name: %s Roll: %d Marks: %.2f\n", i+1, arr[i].name, arr[i].roll, arr[i].marks);
    }
    free(arr);
}

int main(){
    while(1){
        int choice;
        printf("Choose question to run (1-7) or 0 to exit: ");
        if(scanf("%d",&choice)!=1){ printf("Invalid input\n"); break; }
        if(choice==0) break;
        if(choice==1) q1();
        else if(choice==2) q2();
        else if(choice==3) q3();
        else if(choice==4) q4();
        else if(choice==5) q5();
        else if(choice==6) q6();
        else if(choice==7) q7();
        else printf("Invalid choice\n");
    }
    return 0;
}
